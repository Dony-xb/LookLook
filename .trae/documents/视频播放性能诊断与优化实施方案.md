## 诊断目标
- 快速起播：统计首帧时间（first frame），降低 bufferForPlaybackMs。
- 稳定播放：统计重缓冲次数/时长，优化 LoadControl 与网络数据源。
- 滑动切换不卡顿：预加载下一条视频，减少切换空白或黑屏。
- 退出丝滑：统一生命周期与表面释放，避免视频残留。
- 循环播放：播放完成后无停顿继续循环。

## 指标与日志采集（ExoPlayer Analytics）
- 采集：playbackState、isPlaying、onRenderedFirstFrame、onDownstreamFormatChanged、onBandwidthEstimate、onAudioUnderrun、droppedFrames。
- 计算：
  - 首帧耗时：prepare→onRenderedFirstFrame的耗时。
  - 重缓冲统计：STATE_BUFFERING切入次数与总时长。
- 输出：Timber 打印结构化日志，并选项写入内存队列以便后续展示。

## 优化策略
### 1. Player 配置
- 单例 PlayerManager（Hilt Singleton）：集中管理 ExoPlayer 与播放参数；竖屏 Feed 共用单实例，切换仅换 MediaItem。
- LoadControl 调优（DefaultLoadControl）：
  - minBufferMs=15000、maxBufferMs=30000、bufferForPlaybackMs=800、bufferForPlaybackAfterRebufferMs=1500（快速起播、重缓冲后稍加裕量）。
- 重复播放：`player.repeatMode = REPEAT_MODE_ONE`。
- 视图保持：`PlayerView.setKeepContentOnPlayerReset(true)`，切换时避免黑屏闪烁。
- 缩放：`VIDEO_SCALING_MODE_SCALE_TO_FIT_WITH_CROPPING`，与竖屏全屏一致。

### 2. 网络与缓存
- OkHttpDataSourceFactory（或 Media3 OkHttp）：自定义 User-Agent、超时，允许跨协议重定向。
- SimpleCache（200MB）：磁盘缓存 + LeastRecentlyUsedCacheEvictor；使用 CacheDataSource.Factory，提升二次播放与切换速度。
- OBS 链接清洗与范围请求：已做 URL sanitize；确保服务端支持 Range 请求（一般 mp4 可）。

### 3. 预加载与切换
- 播放列表/预缓冲：当前页 + 下一页 MediaItem；在 page 切换时提前设置下一个 MediaItem；或使用 `prepare()` 后延迟 `playWhenReady=true` 以更平滑。
- 切换时保留封面 Overlay（ready=false）并在 `onRenderedFirstFrame` 后移除。

### 4. UI 与生命周期
- READY 前展示封面 + Spinner + 右侧按钮列 + 底部文案（白色）；READY 后移除封面层（不再绘制）。
- 退出：在 `onDispose`/`LaunchedEffect` 跳转时先 `player.pause()`→`clearMediaItems()`→`releaseSurface`（或置空 PlayerView player），避免残留 1 秒的延迟画面。
- 错误重试：`onPlayerError` 显示轻量提示与重试按钮（重新 `setMediaItem`）。

## 代码改动（获批后执行）
- 新建 `player/PlayerManager.kt`（Singleton）：ExoPlayer 构建、LoadControl 配置、数据源/缓存、repeatMode、analytics。
- 新建 Hilt 模块：`CacheModule`（SimpleCache）、`PlayerModule`（PlayerManager）。
- `VideoFeedScreen`：
  - 引入 PlayerManager，移除本地 `ExoPlayer.Builder`。
  - 预加载下一条：在切换页时提前设置 next MediaItem。
  - 封面 Overlay 在 `!ready` 时显示，`onRenderedFirstFrame` 后移除。
  - 错误按钮：显示并触发重新加载。
  - 退出：在 `onDispose` 清理视图绑定与暂停，避免残留。
- README/DevelopmentProcess：新增“性能诊断指标”、“LoadControl 与缓存策略”、“预加载与切换流程”、“退出流程优化”章节。

## 验证
- 打印日志：首帧耗时 < 1s（网络状况正常时），重缓冲次数显著降低。
- 滑动切换：黑屏概率下降，封面→首帧过渡自然。
- 退出：页面元素与视频主体同时淡出，无残留画面。
- 循环播放：单条视频完成后无停顿继续播放。

## 风险与回退
- 缓存占用：限定 200MB 并提供清理接口；低存储设备提示。
- 网络异常：保留本地演示视频作为回退；错误提示与重试。

## 记录
- 在两个既有文档（README、DevelopmentProcess）细化记录，包含参数说明、指标与数据、问题与修复列表。